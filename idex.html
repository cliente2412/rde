<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRE - Controle de Ganhos e Perdas</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- Paleta e reset --- */
    :root{
      --bg:#000000;
      --panel:#0f0f0f;
      --accent:#ff7a00; /* laranja */
      --muted:#bfbfbf;
      --card:#121212;
      --success:#16a34a;
      --danger:#ef4444;
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #070707 100%);color:#fff}

    /* --- Layout --- */
    .container{max-width:1200px;margin:24px auto;padding:24px}
    header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo .mark{width:64px;height:64px;background:linear-gradient(135deg,var(--accent),#ffb366);border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(255,122,0,0.12)}
    .logo .mark strong{color:#000;font-size:22px}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}

    /* --- Painel lateral: formulário e controle mensal --- */
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,0.6)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:#fff}
    .muted{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    .actions{display:flex;gap:8px;margin-top:10px}
    .btn{cursor:pointer;border:none;padding:10px 12px;border-radius:10px;font-weight:600}
    .btn-accent{background:var(--accent);color:#000}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.06)}

    /* --- Resumos e indicadores --- */
    .summary{display:flex;gap:12px;margin-bottom:12px}
    .summary .item{flex:1;background:linear-gradient(180deg,#0b0b0b, #121212);padding:12px;border-radius:10px}
    .summary .value{font-size:18px;font-weight:700}

    /* --- Gráficos area --- */
    .charts{display:grid;grid-template-columns:1fr 400px;gap:18px}
    canvas{background:transparent;border-radius:8px}

    /* --- Transactions list --- */
    .transactions{margin-top:12px;max-height:300px;overflow:auto}
    .tx{display:flex;justify-content:space-between;gap:10px;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .tx .left{display:flex;flex-direction:column}
    .tx .amount{font-weight:700}
    .tx.income .amount{color:var(--success)}
    .tx.expense .amount{color:var(--danger)}

    /* --- Responsivo --- */
    @media (max-width:1000px){.grid{grid-template-columns:1fr}.charts{grid-template-columns:1fr} .logo .mark{width:48px;height:48px}}

    /* Pequenos helpers */
    .pill{display:inline-block;padding:6px 8px;border-radius:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.03)}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="mark"><strong>DRE</strong></div>
        <div>
          <h1>Controle Financeiro — Ganhos & Perdas</h1>
          <p class="lead">Painel simples em uma página com gráficos dinâmicos, cálculo automático e aplicação de gastos mensais.</p>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Lateral: formulário e controle mensal -->
      <aside>
        <div class="card">
          <h3 style="margin-top:0">Registrar transação</h3>
          <div class="muted small">Preencha para adicionar receita ou despesa. Valores positivos sem sinal.</div>
          <div style="height:8px"></div>
          <label>Tipo</label>
          <select id="txType">
            <option value="income">Receita</option>
            <option value="expense">Despesa</option>
          </select>
          <label>Categoria</label>
          <input id="txCategory" placeholder="Ex: Vendas, Salário, Aluguel" />
          <label>Descrição</label>
          <input id="txDesc" placeholder="Descrição curta" />
          <div class="row">
            <div class="col">
              <label>Valor (R$)</label>
              <input id="txAmount" type="number" step="0.01" placeholder="1000" />
            </div>
            <div class="col">
              <label>Data</label>
              <input id="txDate" type="date" />
            </div>
          </div>
          <div style="height:8px"></div>
          <label><input id="txRecurring" type="checkbox" /> Despesa/Receita recorrente (todo mês)</label>
          <div class="actions">
            <button id="addTx" class="btn btn-accent">Adicionar</button>
            <button id="clearAll" class="btn btn-outline">Limpar tudo</button>
          </div>

          <hr style="border:none;height:1px;background:rgba(255,255,255,0.04);margin:12px 0" />

          <h4 style="margin:0 0 8px 0">Controle mensal</h4>
          <div class="muted small">Aplique todas as transações marcadas como recorrentes para o mês selecionado.</div>
          <label>Mês</label>
          <input id="applyMonth" type="month" />
          <div style="height:8px"></div>
          <button id="applyRecurring" class="btn btn-accent">Aplicar gastos mensais</button>

          <div style="height:12px"></div>
          <div class="muted small">Salvar dados localmente no navegador. Você pode exportar se quiser.</div>
          <div style="height:8px"></div>
          <div class="actions">
            <button id="exportCSV" class="btn btn-outline">Exportar CSV</button>
            <button id="importSample" class="btn btn-outline">Importar exemplo</button>
          </div>
        </div>
      </aside>

      <!-- Área principal: resumos, gráficos, lista -->
      <main>
        <div class="summary">
          <div class="item">
            <div class="muted">Receita Total</div>
            <div id="totalIncome" class="value">R$ 0,00</div>
          </div>
          <div class="item">
            <div class="muted">Despesa Total</div>
            <div id="totalExpense" class="value">R$ 0,00</div>
          </div>
          <div class="item">
            <div class="muted">Lucro / Prejuízo</div>
            <div id="netProfit" class="value">R$ 0,00</div>
          </div>
        </div>

        <div class="card charts">
          <div>
            <canvas id="lineBalance" height="220"></canvas>
            <div style="height:12px"></div>
            <canvas id="barCat" height="160"></canvas>
          </div>

          <div class="card" style="padding:12px;display:flex;flex-direction:column;gap:10px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Últimas transações</strong><div class="small muted">(clicar X para remover)</div></div>
              <div class="pill small" id="countTx">0 transações</div>
            </div>
            <div class="transactions" id="txList"></div>
            <div style="height:8px"></div>
            <div style="display:flex;gap:8px">
              <button id="btnShowAll" class="btn btn-outline">Mostrar todas</button>
              <button id="btnResetSample" class="btn btn-outline">Resetar exemplo</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    /* -------------------- Helpers -------------------- */
    const $ = id => document.getElementById(id);
    const formatMoney = v => {
      const n = Number(v) || 0;
      return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    }

    /* -------------------- Estado -------------------- */
    let state = { transactions: [] };

    function load(){
      try{
        const raw = localStorage.getItem('dre_state_v1');
        if(raw) state = JSON.parse(raw);
      }catch(e){console.error(e)}
    }
    function save(){
      localStorage.setItem('dre_state_v1', JSON.stringify(state));
    }

    /* -------------------- Lógica de transações -------------------- */
    function addTransaction(tx){
      // tx = {id, type: 'income'|'expense', category, desc, amount, date, recurring}
      tx.id = Math.random().toString(36).slice(2,9);
      state.transactions.push(tx);
      state.transactions.sort((a,b)=> new Date(b.date) - new Date(a.date));
      save();
      renderAll();
    }

    function removeTransaction(id){
      state.transactions = state.transactions.filter(t=>t.id!==id);
      save();renderAll();
    }

    function clearAll(){
      if(!confirm('Remover todas as transações?')) return;
      state.transactions = []; save(); renderAll();
    }

    /* Apply recurring transactions into chosen month as new entries */
    function applyRecurringToMonth(month){
      // month like 2025-11
      if(!month) {alert('Selecione um mês'); return}
      const [y,m] = month.split('-');
      const day = '01';
      const recurring = state.transactions.filter(t=>t.recurring);
      if(recurring.length===0){alert('Nenhuma transação marcada como recorrente.');return}
      const cloned = recurring.map(t=>({...t, id:Math.random().toString(36).slice(2,9), date: `${y}-${m}-${day}`}));
      state.transactions = state.transactions.concat(cloned);
      save();renderAll();
      alert(cloned.length + ' transações recorrentes aplicadas para ' + month);
    }

    /* -------------------- Resumos e cálculos automáticos -------------------- */
    function calculate(){
      const income = state.transactions.filter(t=>t.type==='income').reduce((s,t)=>s + Number(t.amount),0);
      const expense = state.transactions.filter(t=>t.type==='expense').reduce((s,t)=>s + Number(t.amount),0);
      const net = income - expense;
      return {income, expense, net};
    }

    /* Build data for charts */
    function monthlyBalanceSeries(){
      // Group by month (YYYY-MM)
      const map = {};
      state.transactions.forEach(t=>{
        const dt = new Date(t.date);
        if(isNaN(dt)) return;
        const key = dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0');
        if(!map[key]) map[key]=0;
        map[key] += (t.type==='income' ? Number(t.amount) : -Number(t.amount));
      });
      const keys = Object.keys(map).sort();
      let cumulative = 0;
      const labels = [];
      const data = [];
      keys.forEach(k=>{ cumulative += map[k]; labels.push(k); data.push(Number(cumulative.toFixed(2))); });
      return {labels,data};
    }

    function categoryBarData(){
      const map = {};
      state.transactions.forEach(t=>{
        const key = `${t.category || 'Sem categoria'} (${t.type==='income' ? 'Receita' : 'Despesa'})`;
        if(!map[key]) map[key]=0;
        map[key] += (t.type==='income' ? Number(t.amount) : Number(t.amount));
      });
      const labels = Object.keys(map);
      const data = labels.map(l=>map[l]);
      return {labels,data};
    }

    /* -------------------- Render UI -------------------- */
    function renderAll(){
      // Summary
      const sums = calculate();
      $('totalIncome').innerText = formatMoney(sums.income);
      $('totalExpense').innerText = formatMoney(sums.expense);
      const np = $('netProfit');
      np.innerText = formatMoney(sums.net);
      np.style.color = sums.net>=0 ? 'var(--success)' : 'var(--danger)';

      // Transactions list
      const list = $('txList'); list.innerHTML='';
      const last = state.transactions.slice(0,50);
      $('countTx').innerText = state.transactions.length + ' transações';
      last.forEach(t=>{
        const div = document.createElement('div'); div.className = 'tx ' + (t.type==='income' ? 'income':'expense');
        const left = document.createElement('div'); left.className='left';
        const head = document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between';
        const title = document.createElement('div'); title.innerHTML = `<strong>${t.category || 'Sem categoria'}</strong> <div class="small muted">${t.desc || ''}</div>`;
        const amount = document.createElement('div'); amount.className='amount'; amount.innerText = (t.type==='income' ? '+ ':'- ') + formatMoney(t.amount);
        head.appendChild(title); head.appendChild(amount);
        const foot = document.createElement('div'); foot.className='small muted'; foot.innerText = new Date(t.date).toLocaleDateString();
        const removeBtn = document.createElement('button'); removeBtn.className='btn btn-outline small'; removeBtn.style.padding='6px'; removeBtn.innerText='X'; removeBtn.onclick = ()=>{ if(confirm('Remover transação?')) removeTransaction(t.id) };
        div.appendChild(head);
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
        row.appendChild(foot); row.appendChild(removeBtn);
        div.appendChild(row);
        list.appendChild(div);
      });

      // Charts
      const lb = monthlyBalanceSeries();
      lineChart.data.labels = lb.labels; lineChart.data.datasets[0].data = lb.data; lineChart.update();

      const cb = categoryBarData();
      barChart.data.labels = cb.labels; barChart.data.datasets[0].data = cb.data; barChart.update();
    }

    /* -------------------- Chart setup -------------------- */
    const ctxLine = document.getElementById('lineBalance').getContext('2d');
    const ctxBar = document.getElementById('barCat').getContext('2d');

    const lineChart = new Chart(ctxLine, {
      type: 'line',
      data: {labels:[], datasets:[{label:'Saldo acumulado', data:[], fill:true, tension:0.3, pointRadius:4, borderWidth:2}]},
      options: {responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}, ticks:{color:'#bfbfbf'}}, y:{ticks:{color:'#bfbfbf'}}}, plugins:{legend:{display:false}}}
    });

    const barChart = new Chart(ctxBar, {
      type:'bar',
      data:{labels:[], datasets:[{label:'Valores por categoria', data:[], borderRadius:6, borderSkipped:false}]},
      options:{indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{color:'#bfbfbf'}}, y:{ticks:{color:'#bfbfbf'}}}, plugins:{legend:{display:false}}}
    });

    /* -------------------- Events -------------------- */
    document.getElementById('addTx').addEventListener('click', ()=>{
      const type = $('txType').value;
      const category = $('txCategory').value || (type==='income' ? 'Receita' : 'Despesa');
      const desc = $('txDesc').value || '';
      const amount = parseFloat($('txAmount').value || '0');
      const date = $('txDate').value || new Date().toISOString().slice(0,10);
      const recurring = $('txRecurring').checked;
      if(!amount || amount<=0){alert('Insira um valor maior que 0'); return}
      addTransaction({type,category,desc,amount,date,recurring});
      // reset form fields
      $('txDesc').value=''; $('txAmount').value=''; $('txCategory').value=''; $('txRecurring').checked=false;
    });

    $('clearAll').addEventListener('click', ()=>clearAll());
    $('applyRecurring').addEventListener('click', ()=>applyRecurringToMonth($('applyMonth').value));

    $('exportCSV').addEventListener('click', ()=>{
      const rows = [['id','type','category','desc','amount','date','recurring']];
      state.transactions.forEach(t=> rows.push([t.id,t.type,t.category,t.desc,t.amount,t.date,t.recurring]));
      const csv = rows.map(r=> r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='transactions.csv'; a.click(); URL.revokeObjectURL(url);
    });

    $('importSample').addEventListener('click', ()=>{
      if(!confirm('Substituir/Adicionar transações de exemplo? OK para adicionar.')) return;
      const sample = [
        {type:'income', category:'Vendas', desc:'Venda serviços', amount:12000, date:'2025-10-02', recurring:false},
        {type:'expense', category:'Aluguel', desc:'Loja', amount:2500, date:'2025-10-05', recurring:true},
        {type:'expense', category:'Salários', desc:'Equipe', amount:4000, date:'2025-10-10', recurring:true},
        {type:'income', category:'Manutenção', desc:'Serviços externos', amount:3200, date:'2025-09-14', recurring:false}
      ];
      // add sample
      sample.forEach(s=> addTransaction(s));
    });

    $('btnShowAll').addEventListener('click', ()=>{
      // show alert with count
      alert('Total de transações: ' + state.transactions.length + '\nAbra o console para inspecionar os dados.');
      console.log(state.transactions);
    });

    $('btnResetSample').addEventListener('click', ()=>{
      if(!confirm('Resetar e carregar apenas o exemplo?')) return;
      state.transactions = [];
      const sample = [
        {type:'income', category:'Vendas', desc:'Venda serviços', amount:12000, date:'2025-10-02', recurring:false},
        {type:'expense', category:'Aluguel', desc:'Loja', amount:2500, date:'2025-10-05', recurring:true},
        {type:'expense', category:'Salários', desc:'Equipe', amount:4000, date:'2025-10-10', recurring:true},
        {type:'income', category:'Manutenção', desc:'Serviços externos', amount:3200, date:'2025-09-14', recurring:false}
      ]; sample.forEach(s=> addTransaction(s));
    });

    /* -------------------- Inicialização -------------------- */
    load();
    // if empty, add a tiny hint sample
    if(state.transactions.length===0){
      // do not auto-add sample; wait for user if they want
    }
    renderAll();

    // accessibility: set default month to current
    const now = new Date(); $('applyMonth').value = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');

    /* -------------------- Fim -------------------- */
  </script>
</body>
</html>
